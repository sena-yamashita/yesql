# Yesql ToDo リスト

## DuckDB関連の改善タスク

### 完了済み

#### 1. DuckDBストリーミング実装の修正 ✅
- [x] 存在しないDuckDBex API関数の削除または代替実装
  - `Duckdbex.query_arrow/3` → 削除（Arrow形式は未サポート）
  - `Duckdbex.fetch_arrow_chunk/3` → 削除
  - `Duckdbex.close_arrow_result/1` → 削除
  - `Duckdbex.fetch_chunk/3` → `Duckdbex.fetch_chunk/1`に修正
  - `Duckdbex.close_result/1` → 削除（不要）
  - `Duckdbex.row_count/1` → 削除または別の方法で実装
- [x] `Stream.empty/0` → `Stream.unfold(nil, fn _ -> nil end)`に置き換え
- [x] StreamBufferモジュールの実装

#### 2. テストの修正 ✅
- [x] `test/duckdb_test.exs`のsetup関数を修正
  - データベース接続の正しい取得方法
  - connがbooleanになる問題の解決
- [x] `test/duckdb_streaming_test.exs`の実装
  - 基本的なストリーミングテスト
  - エラーハンドリングのテスト
  - パフォーマンステスト

#### 3. エラーハンドリングの改善
- [ ] ETSテーブル操作のエラーハンドリング追加
- [ ] より具体的なエラータイプの定義
- [ ] パラメータエラーの判定ロジックの改善

### 中優先度

#### 4. パフォーマンス最適化
- [ ] ETSキャッシュのクリーンアップ機構
  - TTL（Time To Live）の実装
  - メモリ使用量の監視
- [ ] 複数ステートメントの並列実行検討
- [ ] バッファリング実装の完成

#### 5. 機能追加
- [ ] 明示的なトランザクション管理
  - BEGIN/COMMIT/ROLLBACKのサポート
  - セーブポイントの実装
- [ ] バッチインサートの最適化
- [ ] 接続プール管理（必要に応じて）
- [ ] クエリタイムアウトの実装

#### 6. ドキュメントの充実
- [ ] DuckDBストリーミングAPIの使用例
- [ ] パラメータ処理の詳細説明
- [ ] エラーハンドリングのベストプラクティス
- [ ] 制限事項と回避策の明記

### 高優先度（設計上の問題）

#### 3. YesQLの設計思想に反する機能の削除
- [ ] create_windowed_stream関数の削除
  - ユーザーのSQLを勝手に改変している
  - WITH句、window_id、ORDER BYを自動追加
- [ ] create_aggregation_stream関数の見直し
  - 一時テーブルの自動作成などSQL生成を行っている
- [ ] export_to_parquet関数の見直し
  - COPY TO文を自動生成している
- [ ] これらの機能は別のヘルパーライブラリとして分離すべき

### 今後の改善余地

#### 7. ストリーミング実装の改善
- [ ] 真のストリーミング実装
  - 現在はfetch_allで全データを取得してからチャンク化している
  - DuckDBexが真のストリーミングAPIを提供するまでの暫定実装
- [ ] チャンクサイズ処理の最適化
  - メモリ効率を考慮したチャンクサイズの動的調整
- [ ] 並列スキャンの完全実装
  - 現在の実装は基本的な機能のみ
  - より効率的な並列処理の実装

#### 8. パフォーマンスの最適化
- [ ] 大規模データセットでのメモリ使用量削減
- [ ] ストリーミング時のCPU使用率最適化
- [ ] プリフェッチバッファの効率改善

#### 9. 機能の拡張
- [ ] Arrowフォーマットのサポート（DuckDBexがサポート次第）
- [ ] create_windowed_stream関数の削除または見直し
  - 現在の実装はユーザーのSQLを勝手に改変しており、YesQLの設計思想に反する
  - ユーザーが自分でウィンドウ関数を含むSQLを書くべき
- [ ] 不適切なSQL生成機能の削除
  - create_aggregation_streamなど、SQLを自動生成する機能は削除すべき

### 低優先度

#### 10. コード品質の改善
- [ ] 未使用の変数の削除
- [ ] 未使用のエイリアスの削除
- [ ] コンパイル警告の解消
- [ ] Dialyzerエラーの修正

#### 11. 互換性の向上
- [ ] 他のドライバーとのAPI統一性
- [ ] 共通インターフェースの実装
- [ ] ベンチマークテストの追加

## 実装の優先順位

1. **完了済み**: ストリーミング実装の基本修正 ✅
2. **完了済み**: テストの動作確保 ✅
3. **次に実装**: エラーハンドリングとETSキャッシュ管理
4. **その後**: パフォーマンス最適化と真のストリーミング実装
5. **最後に**: ドキュメントとコード品質

## 現在の制限事項

### DuckDBストリーミングの制限
- **メモリ使用**: 現在の実装は`fetch_all`で全データを取得してからチャンク化するため、大規模データセットではメモリを大量に使用する
- **パフォーマンス**: 真のストリーミングではないため、最初のデータ取得に時間がかかる
- **並列処理**: 並列スキャンは基本実装のみで、DuckDBの並列処理能力を完全に活用できていない

### 回避策
- 大規模データセットを扱う場合は、WHERE句やLIMIT句でデータ量を制限する
- バッチ処理が必要な場合は、オフセットとリミットを使った手動ページネーションを検討
- メモリ使用量が問題になる場合は、一時テーブルやビューを活用

## 注意事項

- DuckDBexライブラリの制限を理解した上で実装する
- 他のドライバーとの一貫性を保つ
- 後方互換性を維持する
- テストファーストで開発を進める
- DuckDBexの更新に注意し、新しいストリーミングAPIが追加されたら実装を更新する

## 参考資料

- [DuckDBexドキュメント](https://github.com/AlexR2D2/duckdbex)
- 既存のPostgrex/SQLiteドライバー実装
- Yesqlのドライバープロトコル仕様
- [DuckDB公式ドキュメント](https://duckdb.org/docs/)