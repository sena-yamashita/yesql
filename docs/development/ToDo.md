# Yesql ToDo リスト

## DuckDB関連の改善タスク

### 高優先度

#### 1. DuckDBストリーミング実装の修正
- [ ] 存在しないDuckDBex API関数の削除または代替実装
  - `Duckdbex.query_arrow/3` → 削除（Arrow形式は未サポート）
  - `Duckdbex.fetch_arrow_chunk/3` → 削除
  - `Duckdbex.close_arrow_result/1` → 削除
  - `Duckdbex.fetch_chunk/3` → `Duckdbex.fetch_chunk/1`に修正
  - `Duckdbex.close_result/1` → 削除（不要）
  - `Duckdbex.row_count/1` → 削除または別の方法で実装
- [ ] `Stream.empty/0` → `Stream.unfold(nil, fn _ -> nil end)`に置き換え
- [ ] StreamBufferモジュールの正しい実装

#### 2. テストの修正
- [ ] `test/duckdb_test.exs`のsetup関数を修正
  - データベース接続の正しい取得方法
  - connがbooleanになる問題の解決
- [ ] `test/duckdb_streaming_test.exs`の実装
  - 基本的なストリーミングテスト
  - エラーハンドリングのテスト
  - パフォーマンステスト

#### 3. エラーハンドリングの改善
- [ ] ETSテーブル操作のエラーハンドリング追加
- [ ] より具体的なエラータイプの定義
- [ ] パラメータエラーの判定ロジックの改善

### 中優先度

#### 4. パフォーマンス最適化
- [ ] ETSキャッシュのクリーンアップ機構
  - TTL（Time To Live）の実装
  - メモリ使用量の監視
- [ ] 複数ステートメントの並列実行検討
- [ ] バッファリング実装の完成

#### 5. 機能追加
- [ ] 明示的なトランザクション管理
  - BEGIN/COMMIT/ROLLBACKのサポート
  - セーブポイントの実装
- [ ] バッチインサートの最適化
- [ ] 接続プール管理（必要に応じて）
- [ ] クエリタイムアウトの実装

#### 6. ドキュメントの充実
- [ ] DuckDBストリーミングAPIの使用例
- [ ] パラメータ処理の詳細説明
- [ ] エラーハンドリングのベストプラクティス
- [ ] 制限事項と回避策の明記

### 低優先度

#### 7. コード品質の改善
- [ ] 未使用の変数の削除
- [ ] 未使用のエイリアスの削除
- [ ] コンパイル警告の解消
- [ ] Dialyzerエラーの修正

#### 8. 互換性の向上
- [ ] 他のドライバーとのAPI統一性
- [ ] 共通インターフェースの実装
- [ ] ベンチマークテストの追加

## 実装の優先順位

1. **まず修正すべき**: ストリーミング実装（存在しないAPI呼び出し）
2. **次に修正すべき**: テストの動作確保
3. **その後**: エラーハンドリングとパフォーマンス
4. **最後に**: ドキュメントとコード品質

## 注意事項

- DuckDBexライブラリの制限を理解した上で実装する
- 他のドライバーとの一貫性を保つ
- 後方互換性を維持する
- テストファーストで開発を進める

## 参考資料

- [DuckDBexドキュメント](https://github.com/AlexR2D2/duckdbex)
- 既存のPostgrex/SQLiteドライバー実装
- Yesqlのドライバープロトコル仕様