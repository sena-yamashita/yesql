# Yesql ToDo リスト

最終更新: 2025-07-26

## 🎯 プロジェクト全体の状況

### ✅ 完了済みタスク
- DuckDBドライバーの実装と統合
- **全ドライバーのストリーミング機能実装（7/7完了）** ✨
- コンパイル警告の解消
- CIエラーの修正
- DuckDBストリーミングのfetch_chunk対応
- **EctoドライバーのStream対応実装** ✨
- **PostgreSQLドライバーの専用テスト作成（2025-07-26完了）** ✨
- **PostgreSQL/DuckDBキャスト構文(::type)の完全サポート（2025-07-26完了）** ✨
- **GitHub CI環境の修正と全DBテスト対応（2025-07-26完了）** ✨

### 📊 ドライバー実装状況
| ドライバー | 基本機能 | ストリーミング | テスト | 状態 |
|-----------|---------|--------------|--------|------|
| PostgreSQL | ✅ | ✅ | ✅ | 安定 |
| Ecto | ✅ | ✅ | ✅ | フル機能 |
| DuckDB | ✅ | ✅ | ✅ | 高度な機能付き |
| MySQL | ✅ | ✅ | ✅ | 安定 |
| SQLite | ✅ | ✅ | ✅ | 安定 |
| MSSQL | ✅ | ✅ | ✅ | 安定 |
| Oracle | ✅ | ✅ | ✅ | 安定 |

## 🚨 高優先度タスク

### 1. YesQL設計思想の遵守
- [ ] **SQL生成機能の削除または分離**
  - [ ] DuckDBStream: create_windowed_stream（WITH句自動追加）
  - [ ] DuckDBStream: create_aggregation_stream（一時テーブル自動作成）
  - [ ] DuckDBStream: export_to_parquet（COPY TO文自動生成）
  - [ ] DuckDBStream: create_parallel_scan（WHERE句/LIMIT/OFFSET自動追加）
  - [ ] Yesql.Transaction: BEGIN/COMMIT/ROLLBACK自動生成
  - [ ] Yesql.Batch: トランザクション自動管理
- [ ] **別ライブラリへの分離検討**
  - これらの機能は`yesql-helpers`のような別パッケージに

### 2. テストの充実
- [x] **PostgreSQLドライバーの専用テスト作成**（2025-07-26完了）
- [ ] **統合テストの作成**
  - 全ドライバー共通の動作確認
  - パフォーマンス比較

## 📝 中優先度タスク

### 3. エラーハンドリングの改善
- [ ] 統一的なエラー型の定義
- [ ] より詳細なエラーメッセージ
- [ ] SQLファイル不在時の分かりやすいエラー
- [ ] パラメータ不足時の具体的な指示

### 4. パフォーマンス最適化
- [ ] ETSキャッシュのTTL実装
- [ ] メモリ使用量の監視機構
- [ ] 大規模データセットでのベンチマーク
- [ ] 各ドライバーのパフォーマンス比較

### 5. Dialyzer警告の解消
- [ ] Yesql.Streamモジュールの型定義改善
- [ ] 到達不可能なコードパスの修正
- [ ] 型スペックの追加

## 💡 機能改善案

### 6. ドキュメントの充実
- [x] Ectoストリーミングガイド（完了）
- [ ] 各ドライバーの詳細な使用方法
- [ ] ストリーミングAPIのベストプラクティス
- [ ] パフォーマンスチューニングガイド
- [ ] 移行ガイド（他のSQLライブラリから）

### 7. 開発者体験の向上
- [ ] より良いデバッグ情報
- [ ] SQLファイルのホットリロード（開発環境）
- [ ] Visual Studio Code拡張の作成
- [ ] mix yesql.gen.queryタスクの作成
- [ ] エラーメッセージの日本語対応（CLAUDE.md準拠）

### 8. 互換性の向上
- [ ] Ecto 3.13以降の新機能対応
- [ ] OTP 26のサポート確認
- [ ] 新しいデータベースドライバーの追加検討
  - [ ] ClickHouse
  - [ ] CockroachDB
  - [ ] TimescaleDB

## 🔧 技術的改善

### 9. コード品質
- [ ] Dialyzerの完全対応
- [ ] Credo設定の追加
- [ ] ExCoverallsでのカバレッジ測定
- [ ] プロパティベーステストの追加

### 10. CI/CD改善
- [ ] データベース統合テストの自動化
- [ ] パフォーマンス回帰テスト
- [ ] 自動リリース設定
- [ ] ドキュメントの自動生成

## 📌 現在の制限事項と対策

### DuckDBストリーミング
- ✅ ~~fetch_allによる全データ取得~~ → fetch_chunkで解決済み
- DuckDBexのチャンクサイズは約2048行固定

### Ectoストリーミング
- Ecto.Repo.streamはトランザクション内でのみ動作
- カーソルベースストリーミングは実際のRepoが必要

### 各ドライバーの制限
- **PostgreSQL**: 専用テスト不足
- **全般**: JSON処理の依存性が未解決

## 🎯 次のステップ

1. **YesQL設計思想の遵守**を最優先で実施
2. PostgreSQLの専用テスト作成
3. Dialyzer警告の解消
4. 統合テストの作成

## 📈 進捗状況

### 完了率
- 基本機能実装: 100% (7/7)
- ストリーミング実装: 100% (7/7) ✨
- テストカバレッジ: 100% (7/7) ✨
- ドキュメント: 60%

### 最近の成果
- ✅ EctoドライバーのStream対応完了
- ✅ Ecto.Repo.streamの統合
- ✅ カーソルベースストリーミングの実装
- ✅ 並列ストリーミング処理のサポート
- ✅ 包括的なEctoストリーミングドキュメント作成
- ✅ PostgreSQL専用テストスイートの作成（100ケース以上）
  - JSONB、配列、UUID、範囲型などの高度な型サポート
  - ウィンドウ関数、CTE、全文検索のテスト
  - ストリーミング機能の包括的なテスト
  - Yesql統合テスト（defqueryを使用したテスト）
- ✅ データベースキャスト構文の完全サポート
  - PostgreSQL/DuckDBの `::type` 構文を正しく処理
  - 包括的なテストスイート（キャスト構文、回帰テスト、実使用例）
  - 各データベースのキャスト構文に対応（CAST関数、CONVERT関数）
  - デグレードを防ぐ詳細な回帰テストを実装
- ✅ GitHub CI環境の完全修正
  - PostgreSQL、MySQL、MSSQL、SQLiteのDockerサービス設定
  - 環境変数による統一的な接続設定
  - CI環境での自動的なDBテスト実行
  - DuckDBテストの別ジョブ化

## 📚 参考資料

- [YesQL設計原則](../../CLAUDE.md#yesqlの設計原則)
- [各ドライバーの実装状況](./DriverStatus.md)
- [Ectoストリーミングガイド](../guides/ecto_streaming.md)
- [データベースキャスト構文サポート](../guides/cast_syntax_support.md)
- [DuckDBex公式ドキュメント](https://github.com/AlexR2D2/duckdbex)
- [元のyesqlリポジトリ](https://github.com/woylie/yesql)